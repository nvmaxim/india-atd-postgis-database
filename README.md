# Загрузка АТД Индии в БД NSI (вер. 1.2)

## Оглавление

- [Назначение](#назначение)
- [Установка PostgreSQL и PostGIS](#установка-postgresql-и-postgis)
- [Восстановление базы NSI](#восстановление-базы-nsi)
- [Исходные данные](#исходные-данные)
- [Схема базы NSI](#схема-базы-nsi)
- [ETL-процесс](#etl-процесс)
- [SQL скрипты](#sql-скрипты)
- [Приложение](#приложение)

---

## Назначение

**Загрузка данных административно-территориального деления Индии в базу данных NSI.**

Процесс охватывает все уровни административной иерархии от штатов до деревень с установкой соответствующих связей между единицами АТД.

---

## Установка PostgreSQL и PostGIS

### Процесс установки

Процесс установки описан в прилагаемом документе **«ФИМ МэТИ – SQL для прикладных задач – Установка Postgre.pdf»**. 

Раздел по установке DBeaver можно пропустить – перейти непосредственно к установке PostGIS. При установке PostGIS рекомендуется:

- В **Stack Builder** выбрать компоненты: **Spatial Extensions → PostGIS** (последняя версия)
- **Database Drivers** → `npgsql`, `pgjdbc`, `psqlodbc 64 bit`
- При установке PostGIS отметить опцию **«Enable All GDAL Drivers»** для работы с форматом `.tif`

### Ссылка для скачивания

**[PostgreSQL Downloads](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads)** - download link

### Рисунок 1 - Stack Builder установка PostGIS

![Stack Builder установка PostGIS](./media/image1.png)

---

## Восстановление базы NSI

### Описание процесса

Восстановление данных из файла `nsi.dump`. Процесс включает создание базы данных NSI с пользователем postgres. После успешного создания базы NSI необходимо выполнить команду через Query Tools:

```sql
CREATE EXTENSION postgis; -- активация расширения PostGIS в базе данных PostgreSQL
```

### ⚠️ Важно

**Далее необходимо восстановить данные через Restore с форматом Custom or Tar**, указанием пути к файлу `nsi.dump` и имени роли postgres. В разделе **Data Options** отметить опции несохранения (**Do not save**) владельца и прав (**Owner and Privileges**).

### Переход в папку postgresql

```bash
cd "C:\Program Files\PostgreSQL\17\bin"
```

### Запуск восстановления

```bash
.\pg_restore -l "C:\backup\nsi.dump"
```

---

## Исходные данные

### Описание источников

Данные АТД Индии получены из официального источника **[LGDirectory - Local Government Directory of India](https://lgdirectory.gov.in/)**.

### Структура данных по уровням

#### 1. Файлы `atd_*.xlsx`

| Файл | Описание |
|---------|-------------|
| `atd_state.xlsx` | Штаты |
| `atd_district.xlsx` | Округа |
| `atd_subdistrict.xlsx` | Подокруга (техсилы) |
| `atd_village.xlsx` | Деревни |

Каждый файл содержит:
- **Код** уникальной единицы
- **Название** на английском языке
- **Ссылка на родительскую единицу** (код)

#### 2. Таблица `atd_info_area_devision`

Содержит метаданные о структуре АТД (количество единиц на каждом уровне):

| Колонка | Описание |
|---------|-------------|
| **Административные единицы** | State / District / SubDistrict / Village |
| **shape** | Геометрическая форма |
| **link_up_down** | Связь вверх/вниз по иерархии |
| **Иерархические связи** | country, type_devision, status_shape, type_link |
| **Дополнительная информация** | Примечания |

---

## Схема базы NSI

### Общая структура

База данных **NSI** содержит следующие ключевые схемы:

1. **`public`** - схема по умолчанию для временных таблиц
2. **`atd`** - схема с данными АТД
3. **`tiger`** - схема для US Census TIGER/Line

### Таблицы в схеме `atd`

| Таблица | Описание |
|---------|-------------|
| `state` | Штаты Индии |
| `district` | Округа |
| `subdistrict` | Подокруга (техсилы) |
| `village` | Деревни |
| `info_area_devision` | Метаданные о структуре АТД |
| `link_up_down` | Иерархические связи между уровнями |

### Рисунок 2 - ERD for Schema atd

![ERD for Schema atd](./media/image2.png)

#### Примечания

- Таблица `shape` пока **НЕ СОДЕРЖИТ** геометрических данных
- Поле `GEOVIZUALIZ` в исходных данных не может быть пустым

---

## ETL-процесс

Преобразование данных из схемы `public` в схему `atd`. Процесс включает подготовку временных таблиц, обновление записей с установкой временных меток и установку иерархических связей.

![ETL diagram](./media/image3.png)

---

## SQL скрипты

Основные SQL запросы для преобразования данных и установки связей выполняются в строгом порядке.

---

## Приложение

В процессе загрузки новых данных возможны изменения кодов административно-территориальных единиц. Такие ситуации требуют проверки актуальности информации по LGD и корректировки устаревших кодов. Все изменения фиксируются в реестре.

**Пример:** Haryana/Bhiwani/Palumas - обновление кода перед загрузкой Telangana.

```sql
update atd.info_area_devision set code_devision = '61157' 
where id = 14609 and code_devision = '576654';
```

*Реестр дополняется по мере выявления изменений в LGD.*